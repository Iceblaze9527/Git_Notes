---
tags: Git
---

# 01.5 Rewriting History
> BY ç«¥ä»²æ¯…ï¼ˆ[geeeeeeeeek@github](https://github.com/geeeeeeeeek/git-recipes/)ï¼‰
>
> è¿™æ˜¯ä¸€ç¯‡åœ¨[åŸæ–‡ï¼ˆBY atlassianï¼‰](https://www.atlassian.com/git/tutorials/rewriting-history)åŸºç¡€ä¸Šæ¼”ç»çš„è¯‘æ–‡ã€‚é™¤éå¦è¡Œæ³¨æ˜ï¼Œé¡µé¢ä¸Šæ‰€æœ‰å†…å®¹é‡‡ç”¨çŸ¥è¯†å…±äº«-ç½²åï¼ˆ[CC BY 2.5 AU](http://creativecommons.org/licenses/by/2.5/au/deed.zh)ï¼‰åè®®å…±äº«ã€‚
>  
>  Last Modified by Leona Xiang on Oct 16, 2022

Git çš„ä¸»è¦èŒè´£æ˜¯ä¿è¯ä½ ä¸ä¼šä¸¢å¤±æäº¤çš„ä¿®æ”¹ã€‚ä½†æ˜¯ï¼Œå®ƒåŒæ ·è¢«è®¾è®¡æˆè®©ä½ å®Œå…¨æŒæ§å¼€å‘å·¥ä½œæµã€‚è¿™åŒ…æ‹¬äº†è®©ä½ è‡ªå®šä¹‰ä½ çš„é¡¹ç›®å†å²ï¼Œè€Œè¿™ä¹Ÿåˆ›é€ äº†ä¸¢å¤±æäº¤çš„å¯èƒ½æ€§ã€‚Git æä¾›äº†å¯ä»¥é‡å†™é¡¹ç›®å†å²çš„å‘½ä»¤ï¼Œä½†ä¹Ÿè­¦å‘Šä½ è¿™äº›å‘½ä»¤å¯èƒ½ä¼šè®©ä½ ä¸¢å¤±å†…å®¹ã€‚

è¿™ä»½æ•™ç¨‹è®¨è®ºäº†é‡å†™æäº¤å¿«ç…§çš„ä¸€äº›å¸¸è§åŸå› ï¼Œå¹¶å‘Šè¯‰ä½ å¦‚ä½•é¿å…ä¸å¥½çš„å½±å“ã€‚

## 1.5.0 æœ¬èŠ‚æŒ‡ä»¤
```bash=
git commit --amend
git rebase
git rebase -i
git reflog
```

## 1.5.1 `git commit --amend`
`git commit --amend` å‘½ä»¤æ˜¯ä¿®å¤æœ€æ–°æäº¤çš„ä¾¿æ·æ–¹å¼ã€‚å®ƒå…è®¸ä½ å°†ç¼“å­˜çš„ä¿®æ”¹å’Œä¹‹å‰çš„æäº¤åˆå¹¶åˆ°ä¸€èµ·ï¼Œè€Œä¸æ˜¯æäº¤ä¸€ä¸ªå…¨æ–°çš„å¿«ç…§ã€‚å®ƒè¿˜å¯ä»¥ç”¨æ¥ç®€å•åœ°ç¼–è¾‘ä¸Šä¸€æ¬¡æäº¤çš„ä¿¡æ¯è€Œä¸æ”¹å˜å¿«ç…§ã€‚

![Git Tutorial: git commit --amend](https://wac-cdn.atlassian.com/dam/jcr:a4de784b-3572-4d23-8c68-cea9ad4f205f/01.svg =600x)

ä½†æ˜¯ï¼Œamend ä¸åªæ˜¯ä¿®æ”¹äº†æœ€æ–°çš„æäº¤â€”â€”å®ƒè¿›è¡Œäº†ä¸€æ¬¡æ›¿æ¢ã€‚å¯¹äº Git æ¥è¯´ï¼Œè¿™çœ‹ä¸Šå»åƒä¸€ä¸ªå…¨æ–°çš„æäº¤ï¼Œå³ä¸Šå›¾ä¸­ç”¨æ˜Ÿå·è¡¨ç¤ºçš„é‚£ä¸€ä¸ªã€‚åœ¨å…¬å…±ä»“åº“å·¥ä½œæ—¶ä¸€å®šè¦ç‰¢è®°è¿™ä¸€ç‚¹ã€‚

### ä¸è¦ä¿®å¤å…¬å…±æäº¤
**æ°¸è¿œä¸è¦ä¿®å¤ä¸€ä¸ªå·²ç»æ¨é€åˆ°å…¬å…±ä»“åº“ä¸­çš„æäº¤ã€‚**

ä¿®å¤è¿‡çš„æäº¤äº‹å®ä¸Šæ˜¯å…¨æ–°çš„æäº¤ï¼Œä¹‹å‰çš„æäº¤ä¼šè¢«ç§»é™¤å‡ºé¡¹ç›®å†å²ã€‚è¿™å’Œé‡è®¾å…¬å…±å¿«ç…§çš„åæœæ˜¯ä¸€æ ·çš„ã€‚å¦‚æœä½ ä¿®å¤äº†å…¶ä»–å¼€å‘è€…åœ¨ä¹‹åç»§ç»­å¼€å‘çš„ä¸€ä¸ªæäº¤ï¼Œçœ‹ä¸Šå»ä»–ä»¬çš„å·¥ä½œåŸºç¡€ä»é¡¹ç›®å†å²ä¸­æ¶ˆå¤±äº†ä¸€æ ·ã€‚å¯¹äºåœ¨è¿™ä¸Šé¢çš„å¼€å‘è€…æ¥è¯´è¿™æ˜¯å¾ˆå›°æƒ‘çš„ï¼Œè€Œä¸”å¾ˆéš¾æ¢å¤ã€‚

## 1.5.2 `git rebase`
å˜åŸºï¼ˆrebase, äº‹å®ä¸Šè¿™ä¸ªåå­—ååˆ†è¯¡å¼‚, æ‰€ä»¥åœ¨å¤§å¤šæ•°æ—¶å€™ç›´æ¥ç”¨è‹±æ–‡æœ¯è¯­ï¼‰æ˜¯å°†åˆ†æ”¯ç§»åˆ°ä¸€ä¸ªæ–°çš„åŸºæäº¤çš„è¿‡ç¨‹ã€‚è¿‡ç¨‹ä¸€èˆ¬å¦‚ä¸‹æ‰€ç¤ºï¼š

![Git Tutorial: Rebase to maintain a linear project history.](https://wac-cdn.atlassian.com/dam/jcr:e4a40899-636b-4988-9774-eaa8a440575b/02.svg)

ä»å†…å®¹çš„è§’åº¦æ¥çœ‹ï¼Œrebase åªä¸è¿‡æ˜¯å°†åˆ†æ”¯ä»ä¸€ä¸ªæäº¤ç§»åˆ°äº†å¦ä¸€ä¸ªã€‚ä½†ä»å†…éƒ¨æœºåˆ¶æ¥çœ‹ï¼ŒGit æ˜¯é€šè¿‡åœ¨é€‰å®šçš„åŸºä¸Šåˆ›å»ºæ–°æäº¤æ¥å®Œæˆè¿™ä»¶äº‹çš„â€”â€”å®ƒäº‹å®ä¸Šé‡å†™äº†ä½ çš„é¡¹ç›®å†å²ã€‚ç†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå°½ç®¡åˆ†æ”¯çœ‹ä¸Šå»æ˜¯ä¸€æ ·çš„ï¼Œä½†å®ƒåŒ…å«äº†å…¨æ–°çš„æäº¤ã€‚

### ç”¨æ³•
```bash
git rebase <base>
```

å°†å½“å‰åˆ†æ”¯ rebase åˆ° `<base>`ï¼Œè¿™é‡Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„æäº¤å¼•ç”¨ï¼ˆIDã€åˆ†æ”¯åã€æ ‡ç­¾ï¼Œæˆ–æ˜¯ `HEAD` çš„ç›¸å¯¹å¼•ç”¨ï¼‰ã€‚

### è®¨è®º
rebase çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ä¿æŒä¸€ä¸ªçº¿æ€§çš„é¡¹ç›®å†å²ã€‚æ¯”å¦‚è¯´ï¼Œå½“ä½ åœ¨ feature åˆ†æ”¯å·¥ä½œæ—¶ master åˆ†æ”¯å–å¾—äº†ä¸€äº›è¿›å±•ï¼š

![Git Rebase Branch onto Master](https://wac-cdn.atlassian.com/dam/jcr:d3b2abde-d06a-47b6-8955-5f3ef34e0237/03.svg)

è¦å°†ä½ çš„ feature åˆ†æ”¯æ•´åˆè¿› `master` åˆ†æ”¯ï¼Œä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼šç›´æ¥ mergeï¼Œæˆ–è€…å…ˆ rebase å mergeã€‚å‰è€…ä¼šäº§ç”Ÿä¸€ä¸ªä¸‰è·¯åˆå¹¶ï¼ˆ3-way mergeï¼‰å’Œä¸€ä¸ªåˆå¹¶æäº¤ï¼Œè€Œåè€…äº§ç”Ÿçš„æ˜¯ä¸€ä¸ªå¿«é€Ÿå‘å‰çš„åˆå¹¶ä»¥åŠå®Œç¾çš„çº¿æ€§å†å²ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸ºä»€ä¹ˆ rebase åˆ° `master` åˆ†æ”¯ä¼šä¿ƒæˆä¸€ä¸ªå¿«é€Ÿå‘å‰çš„åˆå¹¶ã€‚

![Git Tutorial: Fast-forward merge](https://www.atlassian.com/git/images/tutorials/getting-started/rewriting-history/04.svg)

rebase æ˜¯å°†ä¸Šæ¸¸æ›´æ”¹åˆå¹¶è¿›æœ¬åœ°ä»“åº“çš„é€šå¸¸æ–¹æ³•ã€‚ä½ æ¯æ¬¡æƒ³æŸ¥çœ‹ä¸Šæ¸¸è¿›å±•æ—¶ï¼Œç”¨ `git merge` æ‹‰å–ä¸Šæ¸¸æ›´æ–°ä¼šå¯¼è‡´ä¸€ä¸ªå¤šä½™çš„åˆå¹¶æäº¤ã€‚åœ¨å¦ä¸€æ–¹é¢ï¼Œrebase å°±å¥½åƒæ˜¯è¯´ã€Œæˆ‘æƒ³å°†æˆ‘çš„æ›´æ”¹å»ºç«‹åœ¨å…¶ä»–äººçš„è¿›å±•ä¹‹ä¸Šã€ã€‚

### ä¸è¦ rebase å…¬å…±å†å²
å’Œæˆ‘ä»¬è®¨è®ºè¿‡çš„ `git commit --amend` å’Œ `git reset` ä¸€æ ·ï¼Œä½ æ°¸è¿œä¸åº”è¯¥ rebase é‚£äº›å·²ç»æ¨é€åˆ°å…¬å…±ä»“åº“çš„æäº¤ã€‚rebase ä¼šç”¨æ–°çš„æäº¤æ›¿æ¢æ—§çš„æäº¤ï¼Œä½ çš„é¡¹ç›®å†å²ä¼šåƒçªç„¶æ¶ˆå¤±äº†ä¸€æ ·ã€‚

### æ —å­
ä¸‹é¢è¿™ä¸ªğŸŒ°åŒæ—¶ä½¿ç”¨ git rebase å’Œ git merge æ¥ä¿æŒçº¿æ€§çš„é¡¹ç›®å†å²ã€‚è¿™æ˜¯ä¸€ä¸ªç¡®è®¤ä½ çš„åˆå¹¶éƒ½æ˜¯å¿«é€Ÿå‘å‰çš„æ–¹æ³•ã€‚

```bash
# å¼€å§‹æ–°çš„åŠŸèƒ½åˆ†æ”¯
git checkout -b new-feature master
# ç¼–è¾‘æ–‡ä»¶
git commit -a -m "Start developing a feature"
```

åœ¨ feature åˆ†æ”¯å¼€å‘äº†ä¸€åŠçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ„è¯†åˆ°é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®‰å…¨æ¼æ´:

```bash
# åŸºäºmasteråˆ†æ”¯åˆ›å»ºä¸€ä¸ªå¿«é€Ÿä¿®å¤åˆ†æ”¯
git checkout -b hotfix master
# ç¼–è¾‘æ–‡ä»¶
git commit -a -m "Fix security hole"
# åˆå¹¶å›master
git checkout master
git merge hotfix
git branch -d hotfix
```

å°† hotfix åˆ†æ”¯å¹¶å›ä¹‹å masterï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªåˆ†å‰çš„é¡¹ç›®å†å²ã€‚æˆ‘ä»¬ç”¨ rebase æ•´åˆ feature åˆ†æ”¯ä»¥è·å¾—çº¿æ€§çš„å†å²ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ™®é€šçš„ git mergeã€‚

```bash
git checkout new-feature
git rebase master
```

å®ƒå°† new-feature åˆ†æ”¯ç§»åˆ°äº† master åˆ†æ”¯çš„æœ«ç«¯ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ master ä¸Šè¿›è¡Œæ ‡å‡†çš„å¿«é€Ÿå‘å‰åˆå¹¶äº†:

```bash
git checkout master
git merge new-feature
```

## 1.5.3 [`git rebase -i`](http://jartto.wang/2018/12/11/git-rebase/)
In these or similar instances where it's important to preserve a clean project history, adding the `-i` option to `git rebase` allows you to run `rebase interactive`. This gives you the opportunity to alter individual commits in the process, rather than moving all commits.

### ç”¨æ³•
`git rebase -i <base>`ï¼šå°†å½“å‰åˆ†æ”¯ rebase åˆ° `base`ï¼Œä½†ä½¿ç”¨å¯äº¤äº’çš„å½¢å¼ã€‚å®ƒä¼šæ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸ªå°†è¦ rebase çš„æäº¤è¾“å…¥å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤å†³å®šäº†æ¯ä¸ªæäº¤å°†ä¼šæ€æ ·è¢«è½¬ç§»åˆ°æ–°çš„åŸºä¸Šå»ã€‚ä½ è¿˜å¯ä»¥å¯¹è¿™äº›æäº¤è¿›è¡Œæ’åºã€‚

```bash
s cacc52da add: qrcode  
s f072ef48 update: indexeddb hack  
s 4e84901a feat: add indexedDB floder  
s 8f33126c feat: add test2.js

# Rebase 5f2452b2..8f33126c onto 5f2452b2 (4 commands)  
#  
# Commands:  
# p, pick = use commit  
# r, reword = use commit, but edit the commit message  
# e, edit = use commit, but stop for amending  
# s, squash = use commit, but meld into previous commit  
# f, fixup = like "squash", but discard this commit's log message  
# x, exec = run command (the rest of the line) using shell  
# d, drop = remove commit
```

The `s` "squash" command is where we see the true utility of rebase. Squash allows you to specify which commits you want to merge into the previous commits. This is what enables a "clean history." During rebase playback, Git will execute the specified rebase command for each commit. In the case of squash commits, Git will open your configured text editor and prompt to combine the specified commit messages. This entire process can be visualized as follows:

![Git Tutorial: git rebase -i example](https://wac-cdn.atlassian.com/dam/jcr:2d03f5b6-eaa6-4e78-9dd7-3686ba2a7665/05.svg?cdnVersion=1509 =600x)
Note that the commits modified with a rebase command have a different ID than either of the original commits. Commits marked with pick will have a new ID if the previous commits have been rewritten.

### è®¨è®º
äº¤äº’å¼ rebase ç»™ä½ äº†æ§åˆ¶é¡¹ç›®å†å²çš„å®Œå…¨æŒæ§ã€‚å®ƒç»™äº†å¼€å‘äººå‘˜å¾ˆå¤§çš„è‡ªç”±ï¼Œå› ä¸ºä»–ä»¬å¯ä»¥æäº¤ä¸€ä¸ªã€Œæ··ä¹±ã€çš„å†å²è€Œåªéœ€ä¸“æ³¨äºå†™ä»£ç ï¼Œç„¶åå›å»æ¢å¤å¹²å‡€ã€‚

å¤§å¤šæ•°å¼€å‘è€…å–œæ¬¢åœ¨å¹¶å…¥ä¸»ä»£ç åº“ä¹‹å‰ç”¨äº¤äº’å¼ rebase æ¥å®Œå–„ä»–ä»¬çš„ feature åˆ†æ”¯ã€‚ä»–ä»¬å¯ä»¥å°†ä¸é‡è¦çš„æäº¤åˆåœ¨ä¸€èµ·ï¼Œåˆ é™¤ä¸éœ€è¦çš„ï¼Œç¡®ä¿æ‰€æœ‰ä¸œè¥¿åœ¨æäº¤åˆ°ã€Œæ­£å¼ã€çš„é¡¹ç›®å†å²å‰éƒ½æ˜¯æ•´é½çš„ã€‚å¯¹å…¶ä»–äººæ¥è¯´ï¼Œè¿™ä¸ªåŠŸèƒ½çš„å¼€å‘çœ‹ä¸Šå»æ˜¯ç”±ä¸€ç³»åˆ—ç²¾å¿ƒå®‰æ’çš„æäº¤ç»„æˆçš„ã€‚

## 1.5.4 `git reflog`
Git ç”¨å¼•ç”¨æ—¥å¿—è¿™ç§æœºåˆ¶æ¥è®°å½•åˆ†æ”¯é¡¶ç«¯çš„æ›´æ–°ã€‚å®ƒå…è®¸ä½ å›åˆ°é‚£äº›ä¸è¢«ä»»ä½•åˆ†æ”¯æˆ–æ ‡ç­¾å¼•ç”¨çš„æ›´æ”¹ã€‚åœ¨é‡å†™å†å²åï¼Œå¼•ç”¨æ—¥å¿—åŒ…å«äº†åˆ†æ”¯æ—§çŠ¶æ€çš„ä¿¡æ¯ï¼Œæœ‰éœ€è¦çš„è¯ä½ å¯ä»¥å›åˆ°è¿™ä¸ªçŠ¶æ€ã€‚

### ç”¨æ³•
```bash
git reflog
```

æ˜¾ç¤ºæœ¬åœ°ä»“åº“çš„å¼•ç”¨æ—¥å¿—ã€‚

```bash
git reflog --relative-date
```

ç”¨ç›¸å¯¹çš„æ—¥æœŸæ˜¾ç¤ºå¼•ç”¨æ—¥å¿—ã€‚(å¦‚ 2 å‘¨å‰ï¼‰ã€‚

### è®¨è®º
æ¯æ¬¡å½“å‰çš„ HEAD æ›´æ–°æ—¶ï¼ˆå¦‚åˆ‡æ¢åˆ†æ”¯ã€æ‹‰å–æ–°æ›´æ”¹ã€é‡å†™å†å²æˆ–åªæ˜¯æ·»åŠ æ–°çš„æäº¤ï¼‰ï¼Œå¼•ç”¨æ—¥å¿—éƒ½ä¼šæ·»åŠ ä¸€ä¸ªæ–°æ¡ç›®ã€‚

### æ —å­
ä¸ºäº†ç†è§£ `git reflog`ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªğŸŒ°ã€‚

```bash
0a2e358 HEAD@{0}: reset: moving to HEAD~2
0254ea7 HEAD@{1}: checkout: moving from 2.2 to master
c10f740 HEAD@{2}: checkout: moving from master to 2.2
```

ä¸Šé¢çš„å¼•ç”¨æ—¥å¿—æ˜¾ç¤ºäº† master å’Œ 2.2 çš„ branch ä¹‹é—´çš„ç›¸äº’åˆ‡æ¢ã€‚è¿˜æœ‰å¯¹ä¸€ä¸ªæ›´è€çš„æäº¤çš„å¼ºåˆ¶é‡è®¾ã€‚æœ€è¿‘çš„æ´»åŠ¨ç”¨ `HEAD@{0}` æ ‡è®°åœ¨ä¸Šæ–¹æ˜¾ç¤ºã€‚

å¦‚æœäº‹å®ä¸Šä½ æ˜¯ä¸å°å¿ƒåˆ‡æ¢å›å»çš„ï¼Œå¼•ç”¨æ—¥å¿—åŒ…å«äº†ä½ æ„å¤–åœ°ä¸¢æ‰ä¸¤ä¸ªæäº¤ä¹‹å‰ master æŒ‡å‘çš„æäº¤ 0254ea7ã€‚

```bash
git reset --hard 0254ea7
```

ä½¿ç”¨ [`git reset`](https://github.com/geeeeeeeeek/git-recipes/wiki/2.6-%E5%9B%9E%E6%BB%9A%E9%94%99%E8%AF%AF%E7%9A%84%E4%BF%AE%E6%94%B9#git-reset)ï¼Œå°±æœ‰å¯èƒ½èƒ½å°†masterå˜å›ä¹‹å‰çš„é‚£ä¸ªæäº¤ã€‚å®ƒæä¾›äº†ä¸€å¼ å®‰å…¨ç½‘ï¼Œä»¥é˜²å†å²å‘ç”Ÿæ„å¤–æ›´æ”¹ã€‚

åŠ¡å¿…è®°ä½ï¼Œå¼•ç”¨æ—¥å¿—æä¾›çš„å®‰å…¨ç½‘åªå¯¹æäº¤åˆ°æœ¬åœ°ä»“åº“çš„æ›´æ”¹æœ‰æ•ˆï¼Œè€Œä¸”åªæœ‰ç§»åŠ¨æ“ä½œä¼šè¢«è®°å½•ã€‚